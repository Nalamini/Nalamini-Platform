import { useState, useEffect } from "react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { useAuth } from "@/hooks/use-auth";
import { useMutation, useQuery } from "@tanstack/react-query";
import { apiRequest, queryClient } from "@/lib/queryClient";
import { Recharge } from "@/types";
import PlanDisplay from "@/components/recharge/PlanDisplay";

import {
  Card,
  CardContent,
  CardDescription,
  CardFooter,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Tabs,
  TabsContent,
  TabsList,
  TabsTrigger,
} from "@/components/ui/tabs";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { useToast } from "@/hooks/use-toast";
import {
  Smartphone,
  Zap,
  Wifi,
  Tv,
  Droplet,
  Lightbulb,
  PlugZap,
  PhoneCall,
  Check,
  Loader2,
  ArrowRight,
  AlertCircle,
  AlertTriangle,
  Tag,
  Calendar,
  LifeBuoy,
  Search,
  IndianRupee,
  X,
  RefreshCw,
} from "lucide-react";
import { Badge } from "@/components/ui/badge";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";

// Schema for recharge form, supporting all types of bill payments
const rechargeSchema = z.object({
  mobileNumber: z.string()
    // We validate based on the active tab/service type in the onSubmit function
    .min(1, "This field is required"),
  amount: z.string()
    .min(1, "Amount is required")
    .refine((val) => !isNaN(parseFloat(val)) && parseFloat(val) > 0, {
      message: "Amount must be a positive number",
    }),
  provider: z.string().min(1, "Provider is required"),
  serviceType: z.string().default("mobile"),
});

// Utility function to format date
function formatDate(dateString: string) {
  const date = new Date(dateString);
  return new Intl.DateTimeFormat('en-IN', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  }).format(date);
}

// Interface for plan data
interface Plan {
  id: number;
  category: string;
  amount: number;
  validity: string;
  description: string;
}

interface PlanCategory {
  id: string;
  name: string;
}

interface PlansResponse {
  provider: string;
  categories: {
    data: PlanCategory[];
  };
  plans: Plan[];
  message?: string;
}

type RechargeFormValues = z.infer<typeof rechargeSchema>;

export default function RechargePage() {
  const { user } = useAuth();
  const { toast } = useToast();
  const [activeTab, setActiveTab] = useState("mobile");
  const [viewMode, setViewMode] = useState<'form' | 'plans'>('form');
  const [isBrowsing, setIsBrowsing] = useState(false);
  const [selectedPlan, setSelectedPlan] = useState<Plan | null>(null);
  const [selectedCategory, setSelectedCategory] = useState<string | null>(null);
  const [searchTerm, setSearchTerm] = useState('');

  // Query to fetch recharge history
  const { data: rechargeHistory, isLoading: isLoadingHistory } = useQuery<Recharge[]>({
    queryKey: ["/api/recharge"],
    enabled: !!user,
  });

  // Form for recharge services
  const form = useForm<RechargeFormValues>({
    resolver: zodResolver(rechargeSchema),
    defaultValues: {
      mobileNumber: "",
      amount: "",
      provider: "",
      serviceType: "mobile",
    },
  });

  // Get the currently selected provider
  const selectedProvider = form.watch("provider");

  // Query to fetch plans for the selected provider
  const { 
    data: plansData, 
    isLoading: isLoadingPlans,
    isError: isPlansError,
    refetch: refetchPlans 
  } = useQuery<PlansResponse>({
    queryKey: [`/api/recharge/plans/${selectedProvider}`, activeTab],
    queryFn: async () => {
      if (!selectedProvider) {
        throw new Error("No provider selected");
      }
      
      // Always pass the service type for clarity
      const endpoint = `/api/recharge/plans/${selectedProvider}?serviceType=${activeTab}`;
      
      console.log("DEBUG: Fetching plans from endpoint:", endpoint, "for service type:", activeTab);
      
      try {
        const res = await fetch(endpoint);
        if (!res.ok) {
          console.error("Plans fetch error:", res.status, res.statusText);
          throw new Error(`Failed to fetch plans: ${res.statusText}`);
        }
        const data = await res.json();
        console.log("DEBUG: Plans data received:", data);
        return data;
      } catch (error) {
        console.error("Error fetching plans:", error);
        throw error;
      }
    },
    enabled: !!selectedProvider && viewMode === 'plans',
    staleTime: 0, // Don't cache the results
    refetchOnWindowFocus: false, // Don't refetch when window regains focus
  });
  
  // Refetch plans when we switch to plans view
  useEffect(() => {
    if (viewMode === 'plans' && selectedProvider) {
      console.log("Fetching plans for provider:", selectedProvider);
      refetchPlans();
    }
  }, [viewMode, selectedProvider, refetchPlans]);
  
  // Debug plans data when it changes
  useEffect(() => {
    if (plansData) {
      console.log("Plans data received:", plansData);
      console.log("Plans categories:", plansData.categories?.data);
      console.log("Plans array:", plansData.plans);
    }
  }, [plansData]);

  // Popular recharge amounts
  const popularAmounts = [
    { value: "49", label: "₹49 - 28 Days, 2GB" },
    { value: "199", label: "₹199 - 28 Days, 1.5GB/Day" },
    { value: "249", label: "₹249 - 28 Days, 2GB/Day" },
    { value: "399", label: "₹399 - 56 Days, 2.5GB/Day" },
    { value: "599", label: "₹599 - 84 Days, 2GB/Day" },
    { value: "799", label: "₹799 - 84 Days, 3GB/Day" },
  ];

  // Mobile providers
  const providers = [
    { value: "Airtel", label: "Airtel" },
    { value: "Jio", label: "Jio" },
    { value: "Vi", label: "Vi" },
    { value: "BSNL", label: "BSNL" },
  ];

  // When a provider is selected, check for mode switch
  useEffect(() => {
    if (selectedProvider && viewMode === 'plans') {
      // Reset category selection when provider changes
      setSelectedCategory(null);
      setSelectedPlan(null);
    }
  }, [selectedProvider, viewMode]);

  // When a plan is selected, update the form amount
  useEffect(() => {
    if (selectedPlan) {
      form.setValue("amount", selectedPlan.amount.toString());
    }
  }, [selectedPlan, form]);

  // Filter plans based on category and search term
  const filteredPlans = plansData?.plans?.filter(plan => {
    const matchesCategory = !selectedCategory || plan.category === selectedCategory;
    const matchesSearch = !searchTerm || 
      plan.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
      plan.amount.toString().includes(searchTerm);
    return matchesCategory && matchesSearch;
  }) || [];
  
  // Debug filtered plans
  useEffect(() => {
    console.log("Filtered plans:", filteredPlans);
    console.log("Selected category:", selectedCategory);
  }, [filteredPlans, selectedCategory]);

  // Mutation for recharge and bill payments
  const rechargeMutation = useMutation({
    mutationFn: async (data: RechargeFormValues) => {
      // Set the service type based on active tab
      data.serviceType = activeTab;
      
      const res = await apiRequest("POST", "/api/recharge", {
        ...data,
        amount: parseFloat(data.amount),
      });
      return await res.json();
    },
    onSuccess: (data) => {
      // Customize message based on service type
      let successMessage = "";
      switch (activeTab) {
        case "mobile":
          successMessage = `Mobile number ${form.getValues().mobileNumber} has been recharged successfully.`;
          break;
        case "dth":
          successMessage = `DTH subscription for ${form.getValues().mobileNumber} has been recharged successfully.`;
          break;
        case "electricity":
          successMessage = `Electricity bill for consumer number ${form.getValues().mobileNumber} has been paid successfully.`;
          break;
        default:
          successMessage = `${activeTab.charAt(0).toUpperCase() + activeTab.slice(1)} service payment was successful.`;
      }
      
      toast({
        title: "Payment Successful",
        description: data.apiResponse || successMessage,
      });
      queryClient.invalidateQueries({ queryKey: ["/api/recharge"] });
      queryClient.invalidateQueries({ queryKey: ["/api/user"] });
      setViewMode('form');
      setSelectedPlan(null);
      form.reset();
    },
    onError: (error: Error) => {
      toast({
        title: "Payment Failed",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  // Function to handle form submission
  function onSubmit(values: RechargeFormValues) {
    // Client-side validation based on service type
    if (activeTab === "mobile" && !/^\d{10}$/.test(values.mobileNumber)) {
      toast({
        title: "Validation Error",
        description: "Please enter a valid 10-digit mobile number",
        variant: "destructive",
      });
      return;
    }
    
    rechargeMutation.mutate(values);
  }

  // Toggle between form and plans view
  function toggleViewMode() {
    setViewMode(viewMode === 'form' ? 'plans' : 'form');
    if (viewMode === 'plans') {
      setSelectedPlan(null);
    }
  }

  // Service categories
  const serviceCategories = [
    { id: "mobile", name: "Mobile", icon: <Smartphone className="h-5 w-5" /> },
    { id: "dth", name: "DTH", icon: <Tv className="h-5 w-5" /> },
    { id: "electricity", name: "Electricity", icon: <PlugZap className="h-5 w-5" /> },
    { id: "water", name: "Water", icon: <Droplet className="h-5 w-5" /> },
    { id: "broadband", name: "Broadband", icon: <Wifi className="h-5 w-5" /> },
    { id: "gas", name: "Gas", icon: <Zap className="h-5 w-5" /> },
    { id: "landline", name: "Landline", icon: <PhoneCall className="h-5 w-5" /> },
    { id: "insurance", name: "Insurance", icon: <Lightbulb className="h-5 w-5" /> },
  ];

  return (
    <div className="p-4 sm:p-6 lg:p-8">
      <div className="mb-6">
        <h2 className="text-2xl font-bold text-neutral-900">Recharges & Bill Payments</h2>
        <p className="mt-1 text-sm text-neutral-500">Quickly recharge mobiles and pay utility bills.</p>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Left Column - Service Selection */}
        <div className="lg:col-span-2">
          <Card>
            <CardHeader>
              <CardTitle>Select Service</CardTitle>
              <CardDescription>Choose a service to recharge or pay bills</CardDescription>
            </CardHeader>
            <CardContent>
              <Tabs value={activeTab} onValueChange={setActiveTab}>
                <TabsList className="grid grid-cols-4 sm:grid-cols-8 mb-6">
                  {serviceCategories.map((category) => (
                    <TabsTrigger
                      key={category.id}
                      value={category.id}
                      className="flex flex-col py-2 px-1 h-auto data-[state=active]:bg-primary data-[state=active]:text-primary-foreground"
                    >
                      {category.icon}
                      <span className="mt-1 text-xs">{category.name}</span>
                    </TabsTrigger>
                  ))}
                </TabsList>

                {/* Mobile Recharge Content */}
                <TabsContent value="mobile">
                  {viewMode === 'form' ? (
                    <Form {...form}>
                      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
                        <FormField
                          control={form.control}
                          name="mobileNumber"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Mobile Number</FormLabel>
                              <FormControl>
                                <Input 
                                  placeholder="Enter 10 digit mobile number" 
                                  {...field} 
                                  maxLength={10}
                                />
                              </FormControl>
                              <FormMessage />
                            </FormItem>
                          )}
                        />

                        <FormField
                          control={form.control}
                          name="provider"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>Operator</FormLabel>
                              <Select
                                onValueChange={field.onChange}
                                defaultValue={field.value}
                              >
                                <FormControl>
                                  <SelectTrigger>
                                    <SelectValue placeholder="Select operator" />
                                  </SelectTrigger>
                                </FormControl>
                                <SelectContent>
                                  {providers.map((provider) => (
                                    <SelectItem key={provider.value} value={provider.value}>
                                      {provider.label}
                                    </SelectItem>
                                  ))}
                                </SelectContent>
                              </Select>
                              <FormMessage />
                            </FormItem>
                          )}
                        />

                        <FormField
                          control={form.control}
                          name="amount"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel className="flex justify-between">
                                <span>Amount</span>
                                {selectedProvider && (
                                  <button
                                    type="button"
                                    onClick={toggleViewMode}
                                    className="text-primary text-xs font-medium"
                                  >
                                    Browse Plans
                                  </button>
                                )}
                              </FormLabel>
                              <FormControl>
                                <Input 
                                  placeholder="Enter recharge amount" 
                                  {...field} 
                                  type="number"
                                  min="1"
                                />
                              </FormControl>
                              {!selectedPlan && (
                                <div className="mt-2 flex flex-wrap gap-2">
                                  {popularAmounts.map((amount) => (
                                    <button
                                      key={amount.value}
                                      type="button"
                                      className="text-xs px-2 py-1 border border-neutral-200 rounded hover:bg-neutral-50"
                                      onClick={() => form.setValue("amount", amount.value)}
                                    >
                                      {amount.label}
                                    </button>
                                  ))}
                                </div>
                              )}
                              {selectedPlan && (
                                <div className="mt-2 border rounded p-3 bg-primary/5 relative pr-8">
                                  <button
                                    type="button"
                                    className="absolute top-2 right-2 text-gray-500 hover:text-gray-700"
                                    onClick={() => setSelectedPlan(null)}
                                  >
                                    ✕
                                  </button>
                                  <div className="flex justify-between">
                                    <span className="font-medium">₹{selectedPlan.amount}</span>
                                    <Badge variant="outline">{selectedPlan.validity}</Badge>
                                  </div>
                                  <p className="text-sm text-gray-600 mt-1">{selectedPlan.description}</p>
                                </div>
                              )}
                              <FormMessage />
                            </FormItem>
                          )}
                        />

                        <Button 
                          type="submit" 
                          className="w-full" 
                          disabled={rechargeMutation.isPending}
                        >
                          {rechargeMutation.isPending ? (
                            <>
                              <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                              Processing...
                            </>
                          ) : (
                            <>
                              Proceed to Pay
                              <ArrowRight className="ml-2 h-4 w-4" />
                            </>
                          )}
                        </Button>
                      </form>
                    </Form>
                  ) : (
                    <div>
                      <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-medium">
                          {selectedProvider} Mobile Plans
                        </h3>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={toggleViewMode}
                        >
                          Back to Recharge
                        </Button>
                      </div>

                      {isLoadingPlans ? (
                        <div className="py-12 flex justify-center">
                          <Loader2 className="h-8 w-8 animate-spin text-primary" />
                        </div>
                      ) : isPlansError ? (
                        <div className="py-8 text-center">
                          <AlertCircle className="mx-auto h-8 w-8 text-red-500 mb-2" />
                          <p>Failed to load plans. Please try again.</p>
                          <Button
                            variant="outline"
                            size="sm"
                            onClick={() => refetchPlans()}
                            className="mt-4"
                          >
                            Retry
                          </Button>
                        </div>
                      ) : (
                        <PlanDisplay 
                          plansData={plansData}
                          serviceType="mobile"
                          selectedPlan={selectedPlan}
                          setSelectedPlan={setSelectedPlan}
                          setViewMode={setViewMode}
                          searchTerm={searchTerm}
                          setSearchTerm={setSearchTerm}
                          selectedCategory={selectedCategory}
                          setSelectedCategory={setSelectedCategory}
                        />
                      )}
                    </div>
                  )}
                </TabsContent>

                {/* DTH Recharge Content */}
                <TabsContent value="dth">
                  {viewMode === 'form' ? (
                    <div className="space-y-4">
                      <FormField
                        control={form.control}
                        name="mobileNumber"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Customer ID / Subscriber ID</FormLabel>
                            <FormControl>
                              <Input 
                                placeholder="Enter your DTH subscriber ID" 
                                {...field} 
                                maxLength={12}
                              />
                            </FormControl>
                            <FormDescription>
                              You can find your Subscriber ID on your DTH bill or on-screen by pressing the 'Info' button on your remote.
                            </FormDescription>
                            <FormMessage />
                          </FormItem>
                        )}
                      />

                      <FormField
                        control={form.control}
                        name="provider"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>DTH Operator</FormLabel>
                            <Select
                              onValueChange={field.onChange}
                              defaultValue={field.value}
                            >
                              <FormControl>
                                <SelectTrigger>
                                  <SelectValue placeholder="Select DTH operator" />
                                </SelectTrigger>
                              </FormControl>
                              <SelectContent>
                                <SelectItem value="Tata Play">Tata Play</SelectItem>
                                <SelectItem value="Airtel Digital TV">Airtel Digital TV</SelectItem>
                                <SelectItem value="Dish TV">Dish TV</SelectItem>
                                <SelectItem value="Sun Direct">Sun Direct</SelectItem>
                                <SelectItem value="d2h">d2h</SelectItem>
                              </SelectContent>
                            </Select>
                            <FormMessage />
                          </FormItem>
                        )}
                      />

                      <FormField
                        control={form.control}
                        name="amount"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Amount</FormLabel>
                            <div className="flex gap-2">
                              <FormControl>
                                <Input 
                                  placeholder="Enter recharge amount" 
                                  {...field} 
                                  type="number"
                                  min="1"
                                />
                              </FormControl>
                              <Button 
                                type="button" 
                                variant="outline"
                                onClick={() => {
                                  if (form.getValues("provider")) {
                                    setViewMode('plans');
                                    // Refetch plans will be triggered by the effect hook
                                  } else {
                                    toast({
                                      title: "Please select a DTH operator first",
                                      variant: "destructive",
                                    });
                                  }
                                }}
                              >
                                Browse Plans
                              </Button>
                            </div>
                            <div className="mt-2 flex flex-wrap gap-2">
                              <button
                                type="button"
                                className="text-xs px-2 py-1 border border-neutral-200 rounded hover:bg-neutral-50"
                                onClick={() => form.setValue("amount", "199")}
                              >
                                ₹199 - 1 Month
                              </button>
                              <button
                                type="button"
                                className="text-xs px-2 py-1 border border-neutral-200 rounded hover:bg-neutral-50"
                                onClick={() => form.setValue("amount", "299")}
                              >
                                ₹299 - 1 Month HD
                              </button>
                              <button
                                type="button"
                                className="text-xs px-2 py-1 border border-neutral-200 rounded hover:bg-neutral-50"
                                onClick={() => form.setValue("amount", "499")}
                              >
                                ₹499 - 1 Month Premium
                              </button>
                              <button
                                type="button"
                                className="text-xs px-2 py-1 border border-neutral-200 rounded hover:bg-neutral-50"
                                onClick={() => form.setValue("amount", "999")}
                              >
                                ₹999 - 3 Months
                              </button>
                            </div>
                            <FormMessage />
                          </FormItem>
                        )}
                      />

                      <Button 
                        type="submit" 
                        className="w-full" 
                        onClick={form.handleSubmit(onSubmit)}
                        disabled={rechargeMutation.isPending}
                      >
                        {rechargeMutation.isPending ? (
                          <>
                            <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                            Processing...
                          </>
                        ) : (
                          <>
                            Proceed to Pay
                            <ArrowRight className="ml-2 h-4 w-4" />
                          </>
                        )}
                      </Button>
                    </div>
                  ) : (
                    <div className="space-y-4">
                      <div className="flex justify-between items-center">
                        <h3 className="text-lg font-semibold">{selectedProvider} DTH Packs</h3>
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={() => setViewMode('form')}
                        >
                          <X className="h-4 w-4 mr-2" />
                          Close
                        </Button>
                      </div>
                      
                      {isLoadingPlans ? (
                        <div className="flex justify-center py-12">
                          <Loader2 className="h-8 w-8 animate-spin text-primary" />
                        </div>
                      ) : isPlansError ? (
                        <div className="text-center py-12">
                          <AlertTriangle className="mx-auto h-8 w-8 text-amber-500 mb-2" />
                          <p className="text-neutral-600 mb-1">Failed to load plans</p>
                          <p className="text-sm text-neutral-500 mb-4">
                            There was an error loading the plans. Please try again.
                          </p>
                          <Button 
                            variant="outline" 
                            onClick={() => refetchPlans()}
                            size="sm"
                          >
                            <RefreshCw className="h-4 w-4 mr-2" />
                            Retry
                          </Button>
                        </div>
                      ) : (
                        <PlanDisplay 
                          plansData={plansData}
                          serviceType="dth"
                          selectedPlan={selectedPlan}
                          setSelectedPlan={setSelectedPlan}
                          setViewMode={setViewMode}
                          searchTerm={searchTerm}
                          setSearchTerm={setSearchTerm}
                          selectedCategory={selectedCategory}
                          setSelectedCategory={setSelectedCategory}
                        />
                      )}
                    </div>
                  )}
                </TabsContent>

                {/* Electricity Bill Payment */}
                <TabsContent value="electricity">
                  {viewMode === 'form' ? (
                    <div className="space-y-4">
                      <FormField
                        control={form.control}
                        name="mobileNumber"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Consumer Number / Account ID</FormLabel>
                            <FormControl>
                              <Input 
                                placeholder="Enter your electricity consumer number" 
                                {...field} 
                              />
                            </FormControl>
                            <FormDescription>
                              Consumer number can be found on your electricity bill
                            </FormDescription>
                            <FormMessage />
                          </FormItem>
                        )}
                      />

                      <FormField
                        control={form.control}
                        name="provider"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel>Electricity Board</FormLabel>
                            <Select
                              onValueChange={field.onChange}
                              defaultValue={field.value}
                            >
                              <FormControl>
                                <SelectTrigger>
                                  <SelectValue placeholder="Select electricity provider" />
                                </SelectTrigger>
                              </FormControl>
                              <SelectContent>
                                <SelectItem value="TNEB">Tamil Nadu Electricity Board (TNEB)</SelectItem>
                                <SelectItem value="BESCOM">Bangalore Electricity Supply (BESCOM)</SelectItem>
                                <SelectItem value="KSEB">Kerala State Electricity Board (KSEB)</SelectItem>
                                <SelectItem value="APTRANSCO">Andhra Pradesh Power Distribution</SelectItem>
                                <SelectItem value="TSSPDCL">Telangana State Power Distribution</SelectItem>
                              </SelectContent>
                            </Select>
                            <FormMessage />
                          </FormItem>
                        )}
                      />

                      <FormField
                        control={form.control}
                        name="amount"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel className="flex justify-between">
                              <span>Amount</span>
                              {selectedProvider && (
                                <button
                                  type="button"
                                  onClick={() => {
                                    if (form.getValues("provider")) {
                                      setViewMode('plans');
                                    } else {
                                      toast({
                                        title: "Please select an electricity provider first",
                                        variant: "destructive",
                                      });
                                    }
                                  }}
                                  className="text-primary text-xs font-medium"
                                >
                                  Browse Tariffs
                                </button>
                              )}
                            </FormLabel>
                            <div className="flex gap-2">
                              <FormControl>
                                <Input 
                                  placeholder="Enter bill amount" 
                                  {...field} 
                                  type="number"
                                  min="1"
                                />
                              </FormControl>
                            </div>
                            <FormMessage />
                          </FormItem>
                        )}
                      />

                      <Button 
                        type="submit" 
                        className="w-full" 
                        onClick={form.handleSubmit(onSubmit)}
                        disabled={rechargeMutation.isPending}
                      >
                        {rechargeMutation.isPending ? (
                          <>
                            <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                            Processing...
                          </>
                        ) : (
                          <>
                            Pay Bill
                            <ArrowRight className="ml-2 h-4 w-4" />
                          </>
                        )}
                      </Button>
                    </div>
                  ) : (
                    <div className="space-y-4">
                      <div className="flex justify-between items-center">
                        <h3 className="text-lg font-semibold">{selectedProvider} Tariffs</h3>
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={() => setViewMode('form')}
                        >
                          <X className="h-4 w-4 mr-2" />
                          Close
                        </Button>
                      </div>
                      
                      {isLoadingPlans ? (
                        <div className="flex justify-center py-12">
                          <Loader2 className="h-8 w-8 animate-spin text-primary" />
                        </div>
                      ) : isPlansError ? (
                        <div className="text-center py-12">
                          <AlertTriangle className="mx-auto h-8 w-8 text-amber-500 mb-2" />
                          <p className="text-neutral-600 mb-1">Failed to load tariffs</p>
                          <p className="text-sm text-neutral-500 mb-4">
                            There was an error loading the electricity tariffs. Please try again.
                          </p>
                          <Button 
                            variant="outline" 
                            onClick={() => refetchPlans()}
                            size="sm"
                          >
                            <RefreshCw className="h-4 w-4 mr-2" />
                            Retry
                          </Button>
                        </div>
                      ) : (
                        <PlanDisplay 
                          plansData={plansData}
                          serviceType="electricity"
                          selectedPlan={selectedPlan}
                          setSelectedPlan={setSelectedPlan}
                          setViewMode={setViewMode}
                          searchTerm={searchTerm}
                          setSearchTerm={setSearchTerm}
                          selectedCategory={selectedCategory}
                          setSelectedCategory={setSelectedCategory}
                        />
                      )}
                    </div>
                  )}
                </TabsContent>

                {/* Other service tabs (placeholder for now) */}
                {serviceCategories.filter(c => !["mobile", "dth", "electricity"].includes(c.id)).map((category) => (
                  <TabsContent key={category.id} value={category.id}>
                    <div className="text-center py-12">
                      <div className="mx-auto w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center mb-4">
                        {category.icon}
                      </div>
                      <h3 className="text-lg font-medium mb-2">{category.name} Bill Payment</h3>
                      <p className="text-neutral-500 mb-4">
                        This service will be available soon. Please check back later.
                      </p>
                      <Button 
                        variant="outline" 
                        onClick={() => setActiveTab("mobile")}
                      >
                        Back to Mobile Recharge
                      </Button>
                    </div>
                  </TabsContent>
                ))}
              </Tabs>
            </CardContent>
          </Card>
        </div>

        {/* Right Column - Recent Transactions */}
        <div>
          <Card>
            <CardHeader>
              <CardTitle>Recent Transactions</CardTitle>
              <CardDescription>Your recent recharges and bill payments</CardDescription>
            </CardHeader>
            <CardContent>
              {isLoadingHistory ? (
                <div className="flex justify-center py-8">
                  <Loader2 className="h-8 w-8 animate-spin text-primary" />
                </div>
              ) : rechargeHistory && rechargeHistory.length > 0 ? (
                <div className="space-y-4">
                  {rechargeHistory.map((recharge) => (
                    <div key={recharge.id} className="flex items-start border-b border-neutral-200 pb-4 last:border-0">
                      <div className={`p-2 rounded-full ${
                        recharge.status === "completed" 
                          ? "bg-green-100 text-green-600" 
                          : recharge.status === "failed"
                            ? "bg-red-100 text-red-600"
                            : "bg-yellow-100 text-yellow-600"
                      }`}>
                        {recharge.status === "completed" ? (
                          <Check className="h-4 w-4" />
                        ) : (
                          <AlertCircle className="h-4 w-4" />
                        )}
                      </div>
                      <div className="ml-3 flex-1">
                        <div className="flex justify-between">
                          <p className="text-sm font-medium text-neutral-900">
                            {recharge.provider} Recharge
                          </p>
                          <p className="text-sm font-semibold text-neutral-900">
                            ₹{recharge.amount}
                          </p>
                        </div>
                        <p className="text-xs text-neutral-500">
                          {recharge.mobileNumber}
                        </p>
                        <p className="text-xs text-neutral-500">
                          {formatDate(recharge.createdAt)}
                        </p>
                        <div className="mt-1">
                          <span className={`text-xs px-2 py-0.5 rounded-full ${
                            recharge.status === "completed" 
                              ? "bg-green-100 text-green-600" 
                              : recharge.status === "failed"
                                ? "bg-red-100 text-red-600"
                                : "bg-yellow-100 text-yellow-600"
                          }`}>
                            {recharge.status.charAt(0).toUpperCase() + recharge.status.slice(1)}
                          </span>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div className="text-center py-8">
                  <AlertCircle className="mx-auto h-8 w-8 text-neutral-400 mb-2" />
                  <p className="text-neutral-500">No transactions found</p>
                  <p className="text-xs text-neutral-400 mt-1">
                    Your recharge history will appear here
                  </p>
                </div>
              )}
            </CardContent>
            {rechargeHistory && rechargeHistory.length > 5 && (
              <CardFooter>
                <Button variant="ghost" className="w-full text-primary">
                  View All Transactions
                </Button>
              </CardFooter>
            )}
          </Card>
        </div>
      </div>
    </div>
  );
}
